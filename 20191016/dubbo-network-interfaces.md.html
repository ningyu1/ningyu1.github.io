<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    
<!-- Google Analytics -->
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-113235655-1', 'auto');
ga('send', 'pageview');
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<!-- End Google Analytics -->


    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?83434579b8f6b6a6c80fd1b4fe2d9afa"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    <meta name="google-site-verification" content="tyyr-WLO-Sq85TjMOOOHRRc5YD4W8if8mCXbUD_p_7k">
    
    
    <meta name="sogou_site_verification" content="PlW7T4UKFR">
    
    
    <meta name="baidu-site-verification" content="AdjyK6UssW">
    
    
    <meta name="msvalidate.01" content="BC20DDADC069448DFBCA67D9D7D57546">
    
    
    <meta name="360-site-verification" content="3addb98f1fb5f6b4d1ce03efc23bf5b8">
    
    
    
    <title>[转]研究 Dubbo 网卡地址注册时的一点思考 | 凝雨 - Yun | 快乐编程每一天 - Happy Coding Every Day</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="dubbo,网卡地址注册">
    <meta name="description" content="研究 Dubbo 网卡地址注册时的一点思考">
<meta name="keywords" content="dubbo,网卡地址注册">
<meta property="og:type" content="article">
<meta property="og:title" content="[转]研究 Dubbo 网卡地址注册时的一点思考">
<meta property="og:url" content="https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html">
<meta property="og:site_name" content="凝雨 - Yun">
<meta property="og:description" content="研究 Dubbo 网卡地址注册时的一点思考">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://kirito.iocoder.cn/1918847-496d0e96c237f25a.png">
<meta property="og:image" content="http://kirito.iocoder.cn/1918847-85ea08bc89d9427e.png">
<meta property="og:image" content="http://kirito.iocoder.cn/1918847-ac4155ec7e9489b2.png">
<meta property="og:image" content="http://kirito.iocoder.cn/image-20190429223515625.png">
<meta property="og:updated_time" content="2024-04-23T01:48:15.039Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[转]研究 Dubbo 网卡地址注册时的一点思考">
<meta name="twitter:description" content="研究 Dubbo 网卡地址注册时的一点思考">
<meta name="twitter:image" content="http://kirito.iocoder.cn/1918847-496d0e96c237f25a.png">
    
        <link rel="alternate" type="application/atom+xml" title="凝雨 - Yun" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">凝雨</h5>
          <a href="mailto:ningbe111@163.com" title="ningbe111@163.com" class="mail">ningbe111@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives/"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/ningyu1" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about/"  >
                <i class="icon icon-lg icon-user"></i>
                About
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/atom.xml" target="_blank" >
                <i class="icon icon-lg icon-rss"></i>
                Rss
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://g2.okk.dog/?path=register&code=qn7nOwdj" target="_blank" >
                <i class="icon icon-lg icon-rocket"></i>
                科学上网
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">[转]研究 Dubbo 网卡地址注册时的一点思考</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">[转]研究 Dubbo 网卡地址注册时的一点思考</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-10-16T03:08:26.000Z" itemprop="datePublished" class="page-time">
  2019-10-16
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/dubbo/">dubbo</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>文章目录</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#研究-Dubbo-网卡地址注册时的一点思考"><span class="post-toc-number">1.</span> <span class="post-toc-text">研究 Dubbo 网卡地址注册时的一点思考</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-如何选择合适的网卡地址"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1 如何选择合适的网卡地址</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-Dubbo-是怎么做的"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2 Dubbo 是怎么做的</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-尝试获取-hostname-映射-IP"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">2.1 尝试获取 hostname 映射 IP</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-2-判定有效的-IP-地址"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">2.2 判定有效的 IP 地址</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-轮询网卡"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">2.3 轮询网卡</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-Ifconfig-介绍"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3 Ifconfig 介绍</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-1-常用指令"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">3.1 常用指令</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-2-查看网卡信息"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">3.2 查看网卡信息</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-干扰因素一：Docker-网桥"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">4 干扰因素一：Docker 网桥</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-干扰因素二：TUN-TAP-虚拟网络设备"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">5 干扰因素二：TUN/TAP 虚拟网络设备</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-1-真实网卡工作原理"><span class="post-toc-number">1.5.1.</span> <span class="post-toc-text">5.1 真实网卡工作原理</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-2-TUN-工作原理"><span class="post-toc-number">1.5.2.</span> <span class="post-toc-text">5.2 TUN 工作原理</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-3-TAP-工作原理"><span class="post-toc-number">1.5.3.</span> <span class="post-toc-text">5.3 TAP 工作原理</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-4-openvpn-实战"><span class="post-toc-number">1.5.4.</span> <span class="post-toc-text">5.4 openvpn 实战</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-干扰因素三：多网卡"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">6 干扰因素三：多网卡</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#7-MAC-下的差异"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">7 MAC 下的差异</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#8-Dubbo-改进建议"><span class="post-toc-number">1.8.</span> <span class="post-toc-text">8 Dubbo 改进建议</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#9-参考文章"><span class="post-toc-number">1.9.</span> <span class="post-toc-text">9 参考文章</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-dubbo-network-interfaces.md"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">[转]研究 Dubbo 网卡地址注册时的一点思考</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-10-16 11:08:26" datetime="2019-10-16T03:08:26.000Z"  itemprop="datePublished">2019-10-16</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/dubbo/">dubbo</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>最近看到一篇Apache Dubbo官方Blog中对dubbo网卡实现的代码解读，觉得讲的非常好所以特别分享一下，话不多说直接看原文吧。</p>
<h1 id="研究-Dubbo-网卡地址注册时的一点思考"><a href="#研究-Dubbo-网卡地址注册时的一点思考" class="headerlink" title="研究 Dubbo 网卡地址注册时的一点思考"></a>研究 Dubbo 网卡地址注册时的一点思考</h1><h2 id="1-如何选择合适的网卡地址"><a href="#1-如何选择合适的网卡地址" class="headerlink" title="1 如何选择合适的网卡地址"></a>1 如何选择合适的网卡地址</h2><p>可能相当一部分人还不知道我这篇文章到底要讲什么，我说个场景，大家应该就明晰了。在分布式服务调用过程中，以 Dubbo 为例，服务提供者往往需要将自身的 IP 地址上报给注册中心，供消费者去发现。在大多数情况下 Dubbo 都可以正常工作，但如果你留意过 Dubbo 的 github issue，其实有不少人反馈：Dubbo Provider 注册了错误的 IP。如果你能立刻联想到：多网卡、内外网地址共存、VPN、虚拟网卡等关键词，那我建议你一定要继续将本文看下去，因为我也想到了这些，它们都是本文所要探讨的东西！那么“如何选择合适的网卡地址”呢，Dubbo 现有的逻辑到底算不算完备？我们不急着回答它，而是带着这些问题一起进行研究，相信到文末，其中答案，各位看官自有评说。</p>
<h2 id="2-Dubbo-是怎么做的"><a href="#2-Dubbo-是怎么做的" class="headerlink" title="2 Dubbo 是怎么做的"></a>2 Dubbo 是怎么做的</h2><p>Dubbo 获取网卡地址的逻辑在各个版本中也是千回百转，走过弯路，也做过优化，我们用最新的 2.7.2-SNAPSHOT 版本来介绍，在看以下源码时，大家可以怀着质疑的心态去阅读，在 dubbo github 的 master 分支可以获取源码。获取 localhost 的逻辑位于 <code>org.apache.dubbo.common.utils.NetUtils#getLocalAddress0()</code> 之中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InetAddress <span class="title">getLocalAddress0</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InetAddress localAddress = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 首先尝试获取 /etc/hosts 中 hostname 对应的 IP</span></span><br><span class="line">    localAddress = InetAddress.getLocalHost();</span><br><span class="line">    Optional&lt;InetAddress&gt; addressOp = toValidAddress(localAddress);</span><br><span class="line">    <span class="keyword">if</span> (addressOp.isPresent()) &#123;</span><br><span class="line">        <span class="keyword">return</span> addressOp.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 没有找到适合注册的 IP，则开始轮询网卡</span></span><br><span class="line">    Enumeration&lt;NetworkInterface&gt; interfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == interfaces) &#123;</span><br><span class="line">        <span class="keyword">return</span> localAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (interfaces.hasMoreElements()) &#123;</span><br><span class="line">        NetworkInterface network = interfaces.nextElement();</span><br><span class="line">        Enumeration&lt;InetAddress&gt; addresses = network.getInetAddresses();</span><br><span class="line">        <span class="keyword">while</span> (addresses.hasMoreElements()) &#123;</span><br><span class="line">            <span class="comment">// 返回第一个匹配的适合注册的 IP</span></span><br><span class="line">            Optional&lt;InetAddress&gt; addressOp = toValidAddress(addresses.nextElement());</span><br><span class="line">            <span class="keyword">if</span> (addressOp.isPresent()) &#123;</span><br><span class="line">                <span class="keyword">return</span> addressOp.get();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> localAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dubbo 这段选取本地地址的逻辑大致分成了两步</p>
<ol>
<li>先去 /etc/hosts 文件中找 hostname 对应的 IP 地址，找到则返回；找不到则转 2</li>
<li>轮询网卡，寻找合适的 IP 地址，找到则返回；找不到返回 null，在 getLocalAddress0 外侧还有一段逻辑，如果返回 null，则注册 127.0.0.1 这个本地回环地址</li>
</ol>
<p>首先强调下，这段逻辑并没有太大的问题，先别急着挑刺，让我们来分析下其中的一些细节，并进行验证。</p>
<h3 id="2-1-尝试获取-hostname-映射-IP"><a href="#2-1-尝试获取-hostname-映射-IP" class="headerlink" title="2.1 尝试获取 hostname 映射 IP"></a>2.1 尝试获取 hostname 映射 IP</h3><p>Dubbo 首先选取的是 hostname 对应的 IP，在源码中对应的 <code>InetAddress.getLocalHost();</code>  在 <code>*nix</code> 系统实际部署 Dubbo 应用时，可以首先使用 <code>hostname</code> 命令获取主机名</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">xujingfengdeMacBook-Pro:~ xujingfeng$ hostname</span><br><span class="line">xujingfengdeMacBook-Pro.local</span><br></pre></td></tr></table></figure>
<p>紧接着在 <code>/etc/hosts</code> 配置 IP 映射，为了验证 Dubbo 的机制，我们随意为 hostname 配置一个 IP 地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">127.0.0.1	localhost</span><br><span class="line">1.2.3.4 xujingfengdeMacBook-Pro.local</span><br></pre></td></tr></table></figure>
<p>接着调用 <code>NetUtils.getLocalAddress0()</code> 进行验证，控制台打印如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xujingfengdeMacBook-Pro.local/1.2.3.4</span><br></pre></td></tr></table></figure>
<h3 id="2-2-判定有效的-IP-地址"><a href="#2-2-判定有效的-IP-地址" class="headerlink" title="2.2 判定有效的 IP 地址"></a>2.2 判定有效的 IP 地址</h3><p>在 toValidAddress 逻辑中，Dubbo 存在以下逻辑判定一个 IP 地址是否有效</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Optional&lt;InetAddress&gt; <span class="title">toValidAddress</span><span class="params">(InetAddress address)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (address <span class="keyword">instanceof</span> Inet6Address) &#123;</span><br><span class="line">        Inet6Address v6Address = (Inet6Address) address;</span><br><span class="line">        <span class="keyword">if</span> (isValidV6Address(v6Address)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Optional.ofNullable(normalizeV6Address(v6Address));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isValidV4Address(address)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.of(address);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Optional.empty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>依次校验其符合 Ipv6 或者 Ipv4 的 IP 规范，对于 Ipv6 的地址，见如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidV6Address</span><span class="params">(Inet6Address address)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> preferIpv6 = Boolean.getBoolean(<span class="string">"java.net.preferIPv6Addresses"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!preferIpv6) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> address.isReachable(<span class="number">100</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先获取 <code>java.net.preferIPv6Addresses</code> 参数，其默认值为 false，鉴于大多数应用并没有使用 Ipv6 地址作为理想的注册 IP，这问题不大，紧接着通过 isReachable 判断网卡的连通性。例如一些网卡可能是 VPN/虚拟网卡的地址，如果没有配置路由表，往往无法连通，可以将之过滤。</p>
<p>对于 Ipv4 的地址，见如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidV4Address</span><span class="params">(InetAddress address)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (address == <span class="keyword">null</span> || address.isLoopbackAddress()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String name = address.getHostAddress();</span><br><span class="line">    <span class="keyword">boolean</span> result = (name != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; IP_PATTERN.matcher(name).matches()</span><br><span class="line">            &amp;&amp; !Constants.ANYHOST_VALUE.equals(name)</span><br><span class="line">            &amp;&amp; !Constants.LOCALHOST_VALUE.equals(name));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对比 Ipv6 的判断，这里我们已经发现前后不对称的情况了</p>
<ul>
<li>Ipv4 相比 Ipv6 的逻辑多了 Ipv4 格式的正则校验、本地回环地址校验、ANYHOST 校验</li>
<li>Ipv4 相比 Ipv6 的逻辑少了网卡连通性的校验</li>
</ul>
<p>大家都知道，Ipv4 将 127.0.0.1 定为本地回环地址， Ipv6 也存在回环地址：0:0:0:0:0:0:0:1 或者表示为 ::1。改进建议也很明显，我们放到文末统一总结。</p>
<h3 id="2-3-轮询网卡"><a href="#2-3-轮询网卡" class="headerlink" title="2.3 轮询网卡"></a>2.3 轮询网卡</h3><p>如果上述地址获取为 null 则进入轮询网卡的逻辑（例如 hosts 未指定 hostname 的映射或者 hostname 配置成了 127.0.0.1 之类的地址便会导致获取到空的网卡地址），轮询网卡对应的源码是 <code>NetworkInterface.getNetworkInterfaces()</code> ，这里面涉及的知识点就比较多了，支撑起了我写这篇文章的素材，Dubbo 的逻辑并不复杂，进行简单的校验，返回第一个可用的 IP 即可。</p>
<p>性子急的读者可能忍不住了，多网卡！合适的网卡可能不止一个，Dubbo 怎么应对呢？按道理说，我们也替 Dubbo 说句公道话，客官要不你自己指定下？我们首先得对多网卡的场景达成一致看法，才能继续把这篇文章完成下去：我们只能<strong>尽可能</strong>过滤那些“<strong>不对</strong>”的网卡。Dubbo 看样子对所有网卡是一视同仁了，那么是不是可以尝试优化一下其中的逻辑呢？</p>
<p>许多开源的服务治理框架在 stackoverflow 或者其 issue 中，注册错 IP 相关的问题都十分高频，大多数都是轮询网卡出了问题。既然事情发展到这儿，势必需要了解一些网络、网卡的知识，我们才能过滤掉那些明显不适合 RPC 服务注册的 IP 地址了。</p>
<h2 id="3-Ifconfig-介绍"><a href="#3-Ifconfig-介绍" class="headerlink" title="3 Ifconfig 介绍"></a>3 Ifconfig 介绍</h2><p>我并没有想要让大家对后续的内容望而却步，特地选择了这个大家最熟悉的 Linux 命令！对于那些吐槽：“天呐，都 2019 年了，你怎么还在用 net-tools/ifconfig，iproute2/ip 了解一下”的言论，请大家视而不见。无论你使用的是 mac，还是 linux，都可以使用它去 CRUD 你的网卡配置。</p>
<h3 id="3-1-常用指令"><a href="#3-1-常用指令" class="headerlink" title="3.1 常用指令"></a>3.1 常用指令</h3><p><strong>启动关闭指定网卡：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig eth0 up</span><br><span class="line">ifconfig eth0 down</span><br></pre></td></tr></table></figure>
<p><code>ifconfig eth0 up</code> 为启动网卡 eth0，<code>ifconfig eth0 down</code> 为关闭网卡 eth0。ssh 登陆 linux 服务器操作的用户要小心执行这个操作了，千万不要蠢哭自己。不然你下一步就需要去 google：“禁用 eth0 网卡后如何远程连接 Linux 服务器” 了。</p>
<p><strong>为网卡配置和删除IPv6地址：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig eth0 add 33ffe:3240:800:1005::2/64    #为网卡eth0配置IPv6地址</span><br><span class="line">ifconfig eth0 del 33ffe:3240:800:1005::2/64    #为网卡eth0删除IPv6地址</span><br></pre></td></tr></table></figure>
<p><strong>用 ifconfig 修改 MAC 地址：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig eth0 hw ether 00:AA:BB:CC:dd:EE</span><br></pre></td></tr></table></figure>
<p><strong>配置 IP 地址：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ifconfig eth0 192.168.2.10</span><br><span class="line">[root@localhost ~]# ifconfig eth0 192.168.2.10 netmask 255.255.255.0</span><br><span class="line">[root@localhost ~]# ifconfig eth0 192.168.2.10 netmask 255.255.255.0 broadcast 192.168.2.255</span><br></pre></td></tr></table></figure>
<p><strong>启用和关闭arp协议：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig eth0 arp    #开启网卡eth0 的arp协议</span><br><span class="line">ifconfig eth0 -arp   #关闭网卡eth0 的arp协议</span><br></pre></td></tr></table></figure>
<p><strong>设置最大传输单元：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig eth0 mtu 1500    #设置能通过的最大数据包大小为 1500 bytes</span><br></pre></td></tr></table></figure>
<h3 id="3-2-查看网卡信息"><a href="#3-2-查看网卡信息" class="headerlink" title="3.2 查看网卡信息"></a>3.2 查看网卡信息</h3><p>在一台 ubuntu 上执行 <code>ifconfig -a</code> </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@VM-30-130-ubuntu:~$ ifconfig -a</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 52:54:00:a9:5f:ae</span><br><span class="line">          inet addr:10.154.30.130  Bcast:10.154.63.255  Mask:255.255.192.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:149673 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:152271 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:15205083 (15.2 MB)  TX bytes:21386362 (21.3 MB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line">          </span><br><span class="line">docker0   Link encap:Ethernet  HWaddr 02:42:58:45:c1:15</span><br><span class="line">          inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00</span><br><span class="line">          UP POINTOPOINT NOARP MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:100</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<p>为了防止黑客对我的 Linux 发起攻击，我还是偷偷对 IP 做了一点“改造”，请不要为难一个趁着打折+组团购买廉价云服务器的小伙子。对于部分网卡的详细解读:</p>
<p>eth0 表示第一块网卡， 其中 HWaddr 表示网卡的物理地址，可以看到目前这个网卡的物理地址(MAC 地址）是 02:42:38:52:70:54</p>
<p>inet addr 用来表示网卡的 IP 地址，此网卡的 IP 地址是 10.154.30.130，广播地址， Bcast: 172.18.255.255，掩码地址 Mask:255.255.0.0 </p>
<p>lo 是表示主机的回环地址，这个一般是用来测试一个网络程序，但又不想让局域网或外网的用户能够查看，只能在此台主机上运行和查看所用的网络接口。比如把 HTTPD 服务器的指定到回坏地址，在浏览器输入 127.0.0.1 就能看到你所架构的 WEB 网站了。但只有你能看得到，局域网的其它主机或用户则无从知晓。</p>
<p>第一行：连接类型：Ethernet（以太网）HWaddr（硬件mac地址）</p>
<p>第二行：网卡的IP地址、子网、掩码</p>
<p>第三行：UP（代表网卡开启状态）RUNNING（代表网卡的网线被接上）MULTICAST（支持组播）MTU:1500（最大传输单元）：1500字节（ifconfig 不加 -a 则无法看到 DOWN 的网卡）</p>
<p>第四、五行：接收、发送数据包情况统计</p>
<p>第七行：接收、发送数据字节数统计信息。</p>
<p>紧接着的两个网卡 docker0，tun0 是怎么出来的呢？我在我的 ubuntu 上装了 docker 和 openvpn。这两个东西应该是日常干扰我们做服务注册时的罪魁祸首了，当然，也有可能存在 eth1 这样的第二块网卡。ifconfig -a 看到的东西就对应了 JDK 的 api ：<code>NetworkInterface.getNetworkInterfaces()</code> 。我们简单做个总结，大致有三个干扰因素</p>
<ul>
<li>以 docker 网桥为首的虚拟网卡地址，毕竟这东西这么火，怎么也得单独列出来吧？</li>
<li>以 TUN/TAP 为代表的虚拟网卡地址，多为 VPN 场景</li>
<li>以 eth1 为代表的多网卡场景，有钱就可以装多网卡了！</li>
</ul>
<p>我们后续的篇幅将针对这些场景做分别的介绍，力求让大家没吃过猪肉，起码看下猪怎么跑的。</p>
<h2 id="4-干扰因素一：Docker-网桥"><a href="#4-干扰因素一：Docker-网桥" class="headerlink" title="4 干扰因素一：Docker 网桥"></a>4 干扰因素一：Docker 网桥</h2><p>熟悉 docker 的朋友应该知道 docker 会默认创建一个 docker0 的网桥，供容器实例连接。如果嫌默认的网桥不够直观，我们可以使用 bridge 模式自定义创建一个新的网桥：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@VM-30-130-ubuntu:~$ docker network create kirito-bridge</span><br><span class="line">a38696dbbe58aa916894c674052c4aa6ab32266dcf6d8111fb794b8a344aa0d9</span><br><span class="line">ubuntu@VM-30-130-ubuntu:~$ ifconfig -a</span><br><span class="line">br-a38696dbbe58 Link encap:Ethernet  HWaddr 02:42:6e:aa:fd:0c</span><br><span class="line">          inet addr:172.19.0.1  Bcast:172.19.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<p>使用 docker network 指令创建网桥之后，自动创建了对应的网卡，我只给出了 <code>ifconfig -a</code> 的增量返回部分，可以看出多了一个 br-a38696dbbe58 的网卡。</p>
<p>我有意区分了“网桥”和“网卡”，可以使用 bridge-utils/brctl 来查看网桥信息：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@VM-30-130-ubuntu:~$ sudo brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">br-a38696dbbe58		8000.02426eaafd0c	no</span><br><span class="line">docker0		8000.02425845c215	no</span><br></pre></td></tr></table></figure>
<p>网桥是一个虚拟设备，这个设备只有 brctl show 能看到，网桥创建之后，会自动创建一个同名的网卡，并将这个网卡加入网桥。</p>
<h2 id="5-干扰因素二：TUN-TAP-虚拟网络设备"><a href="#5-干扰因素二：TUN-TAP-虚拟网络设备" class="headerlink" title="5 干扰因素二：TUN/TAP 虚拟网络设备"></a>5 干扰因素二：TUN/TAP 虚拟网络设备</h2><p>平时我们所说的虚拟网卡、虚拟机，大致都跟 TUN/TAP 有关。我的读者大多数是 Java 从业者，相信我下面的内容并没有太超纲，不要被陌生的名词唬住。对于被唬住的读者，也可以直接跳过 5.1~5.3，直接看 5.4 的实战。</p>
<h3 id="5-1-真实网卡工作原理"><a href="#5-1-真实网卡工作原理" class="headerlink" title="5.1 真实网卡工作原理"></a>5.1 真实网卡工作原理</h3><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://kirito.iocoder.cn/1918847-496d0e96c237f25a.png" alt="1918847-496d0e96c237f25a" title>
                </div>
                <div class="image-caption">1918847-496d0e96c237f25a</div>
            </figure>
<p>上图中的 <strong>eth0</strong> 表示我们主机已有的真实的网卡接口 (<strong>interface</strong>)。</p>
<p>网卡接口 <strong>eth0</strong> 所代表的真实网卡通过网线(<strong>wire</strong>)和外部网络相连，该物理网卡收到的数据包会经由接口 <strong>eth0</strong> 传递给内核的网络协议栈(<strong>Network Stack</strong>)。然后协议栈对这些数据包进行进一步的处理。</p>
<p>对于一些错误的数据包,协议栈可以选择丢弃；对于不属于本机的数据包，协议栈可以选择转发；而对于确实是传递给本机的数据包,而且该数据包确实被上层的应用所需要，协议栈会通过 <strong>Socket API</strong> 告知上层正在等待的应用程序。</p>
<h3 id="5-2-TUN-工作原理"><a href="#5-2-TUN-工作原理" class="headerlink" title="5.2 TUN 工作原理"></a>5.2 TUN 工作原理</h3><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://kirito.iocoder.cn/1918847-85ea08bc89d9427e.png" alt="1918847-85ea08bc89d9427e" title>
                </div>
                <div class="image-caption">1918847-85ea08bc89d9427e</div>
            </figure>
<p>我们知道，普通的网卡是通过网线来收发数据包的话，而 <strong>TUN</strong> 设备比较特殊，它通过一个文件收发数据包。</p>
<p>如上图所示，<strong>tunX</strong> 和上面的 <strong>eth0</strong> 在逻辑上面是等价的， <strong>tunX</strong> 也代表了一个网络接口,虽然这个接口是系统通过软件所模拟出来的.</p>
<p>网卡接口 <strong>tunX 所代表的虚拟网卡通过文件 /dev/tunX 与我们的应用程序(App)相连</strong>，应用程序每次使用 <strong>write</strong> 之类的系统调用将数据写入该文件，这些数据会以网络层数据包的形式，通过该虚拟网卡，经由网络接口 <strong>tunX</strong> 传递给网络协议栈，同时该应用程序也可以通过 <strong>read</strong> 之类的系统调用，经由文件 <strong>/dev/tunX</strong> 读取到协议栈向 <strong>tunX</strong> 传递的<strong>所有</strong>数据包。</p>
<p>此外，协议栈可以像操纵普通网卡一样来操纵 <strong>tunX</strong> 所代表的虚拟网卡。比如说，给 <strong>tunX</strong> 设定 <strong>IP</strong> 地址，设置路由，总之，在协议栈看来，<strong>tunX</strong> 所代表的网卡和其他普通的网卡区别不大，当然，硬要说区别，那还是有的,那就是 <strong>tunX</strong> 设备不存在 <strong>MAC</strong> 地址，这个很好理解，<strong>tunX</strong> 只模拟到了网络层，要 <strong>MAC</strong>地址没有任何意义。当然，如果是 <strong>tapX</strong> 的话，在协议栈的眼中，<strong>tapX</strong> 和真实网卡没有任何区别。</p>
<p>是不是有些懵了？我是谁，为什么我要在这篇文章里面学习 TUN！因为我们常用的 VPN 基本就是基于 TUN/TAP 搭建的，如果我们使用 <strong>TUN</strong> 设备搭建一个基于 <strong>UDP</strong> 的 <strong>VPN</strong> ，那么整个处理过程可能是这幅样子：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://kirito.iocoder.cn/1918847-ac4155ec7e9489b2.png" alt="1918847-ac4155ec7e9489b2" title>
                </div>
                <div class="image-caption">1918847-ac4155ec7e9489b2</div>
            </figure>
<h3 id="5-3-TAP-工作原理"><a href="#5-3-TAP-工作原理" class="headerlink" title="5.3 TAP 工作原理"></a>5.3 TAP 工作原理</h3><p><strong>TAP</strong> 设备与 <strong>TUN</strong> 设备工作方式完全相同，区别在于：</p>
<ol>
<li><strong>TUN</strong> 设备是一个三层设备，它只模拟到了 <strong>IP</strong> 层，即网络层 我们可以通过 <strong>/dev/tunX</strong> 文件收发 <strong>IP</strong> 层数据包，它无法与物理网卡做 <strong>bridge</strong>，但是可以通过三层交换（如  <strong>ip_forward</strong>）与物理网卡连通。可以使用<code>ifconfig</code>之类的命令给该设备设定 <strong>IP</strong> 地址。</li>
<li><strong>TAP</strong> 设备是一个二层设备，它比 <strong>TUN</strong> 更加深入，通过 <strong>/dev/tapX</strong> 文件可以收发 <strong>MAC</strong> 层数据包，即数据链路层，拥有 <strong>MAC</strong> 层功能，可以与物理网卡做 <strong>bridge</strong>，支持 <strong>MAC</strong> 层广播。同样的，我们也可以通过<code>ifconfig</code>之类的命令给该设备设定 <strong>IP</strong> 地址，你如果愿意，我们可以给它设定 <strong>MAC</strong> 地址。</li>
</ol>
<p>关于文章中出现的二层，三层，我这里说明一下，第一层是物理层，第二层是数据链路层，第三层是网络层，第四层是传输层。</p>
<h3 id="5-4-openvpn-实战"><a href="#5-4-openvpn-实战" class="headerlink" title="5.4 openvpn 实战"></a>5.4 openvpn 实战</h3><p>openvpn 是 Linux 上一款开源的 vpn 工具，我们通过它来复现出影响我们做网卡选择的场景。</p>
<p>安装 openvpn</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install openvpn</span><br></pre></td></tr></table></figure>
<p>安装一个 TUN 设备：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@VM-30-130-ubuntu:~$ sudo openvpn --mktun --dev tun0</span><br><span class="line">Mon Apr 29 22:23:31 2019 TUN/TAP device tun0 opened</span><br><span class="line">Mon Apr 29 22:23:31 2019 Persist state set to: ON</span><br></pre></td></tr></table></figure>
<p>安装一个 TAP 设备：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@VM-30-130-ubuntu:~$ sudo openvpn --mktun --dev tap0</span><br><span class="line">Mon Apr 29 22:24:36 2019 TUN/TAP device tap0 opened</span><br><span class="line">Mon Apr 29 22:24:36 2019 Persist state set to: ON</span><br></pre></td></tr></table></figure>
<p>执行 <code>ifconfig -a</code> 查看网卡，只给出增量的部分：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tap0      Link encap:Ethernet  HWaddr 7a:a2:a8:f1:6b:df</span><br><span class="line">          BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:100</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00</span><br><span class="line">          inet addr:10.154.30.131  P-t-P:10.154.30.131  Mask:255.255.255.255</span><br><span class="line">          UP POINTOPOINT NOARP MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:100</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<p>这样就解释了文章一开始为什么会有 tun0 这样的网卡了。这里读者可能会有疑惑，使用 ifconfig 不是也可以创建 tap 和 tun 网卡吗？当然啦，openvpn 是一个 vpn 工具，只能创建名为 tunX/tapX 的网卡，其遵守着一定的规范，ifconfig 可以随意创建，但没人认那些随意创建的网卡。</p>
<h2 id="6-干扰因素三：多网卡"><a href="#6-干扰因素三：多网卡" class="headerlink" title="6 干扰因素三：多网卡"></a>6 干扰因素三：多网卡</h2><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://kirito.iocoder.cn/image-20190429223515625.png" alt="image-20190429223515625" title>
                </div>
                <div class="image-caption">image-20190429223515625</div>
            </figure>
<p>这个没有太多好说的，有多张真实的网卡，从普哥那儿搞到如上的 IP 信息。</p>
<h2 id="7-MAC-下的差异"><a href="#7-MAC-下的差异" class="headerlink" title="7 MAC 下的差异"></a>7 MAC 下的差异</h2><p>虽然 ifconfig 等指令是 <code>*nux</code> 通用的，但是其展示信息，网卡相关的属性和命名都有较大的差异。例如这是我 MAC 下执行 <code>ifconfig -a</code> 的返回：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">xujingfengdeMacBook-Pro:dubbo-in-action xujingfeng$ ifconfig -a</span><br><span class="line">lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu 16384</span><br><span class="line">	options=1203&lt;RXCSUM,TXCSUM,TXSTATUS,SW_TIMESTAMP&gt;</span><br><span class="line">	inet 127.0.0.1 netmask 0xff000000</span><br><span class="line">	inet6 ::1 prefixlen 128</span><br><span class="line">	inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1</span><br><span class="line">	nd6 options=201&lt;PERFORMNUD,DAD&gt;</span><br><span class="line">gif0: flags=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1280</span><br><span class="line">stf0: flags=0&lt;&gt; mtu 1280</span><br><span class="line">XHC0: flags=0&lt;&gt; mtu 0</span><br><span class="line">XHC20: flags=0&lt;&gt; mtu 0</span><br><span class="line">en0: flags=8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500</span><br><span class="line">	ether 88:e9:fe:88:a0:76</span><br><span class="line">	inet6 fe80::1cab:f689:60d1:bacb%en0 prefixlen 64 secured scopeid 0x6</span><br><span class="line">	inet 30.130.11.242 netmask 0xffffff80 broadcast 30.130.11.255</span><br><span class="line">	nd6 options=201&lt;PERFORMNUD,DAD&gt;</span><br><span class="line">	media: autoselect</span><br><span class="line">	status: active</span><br><span class="line">p2p0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 2304</span><br><span class="line">	ether 0a:e9:fe:88:a0:76</span><br><span class="line">	media: autoselect</span><br><span class="line">	status: inactive</span><br><span class="line">awdl0: flags=8943&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1484</span><br><span class="line">	ether 66:d2:8c:8c:dd:85</span><br><span class="line">	inet6 fe80::64d2:8cff:fe8c:dd85%awdl0 prefixlen 64 scopeid 0x8</span><br><span class="line">	nd6 options=201&lt;PERFORMNUD,DAD&gt;</span><br><span class="line">	media: autoselect</span><br><span class="line">	status: active</span><br><span class="line">en1: flags=8963&lt;UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1500</span><br><span class="line">	options=60&lt;TSO4,TSO6&gt;</span><br><span class="line">	ether aa:00:d0:13:0e:01</span><br><span class="line">	media: autoselect &lt;full-duplex&gt;</span><br><span class="line">	status: inactive</span><br><span class="line">en2: flags=8963&lt;UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1500</span><br><span class="line">	options=60&lt;TSO4,TSO6&gt;</span><br><span class="line">	ether aa:00:d0:13:0e:00</span><br><span class="line">	media: autoselect &lt;full-duplex&gt;</span><br><span class="line">	status: inactive</span><br><span class="line">bridge0: flags=8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500</span><br><span class="line">	options=63&lt;RXCSUM,TXCSUM,TSO4,TSO6&gt;</span><br><span class="line">	ether aa:00:d0:13:0e:01</span><br><span class="line">	Configuration:</span><br><span class="line">		id 0:0:0:0:0:0 priority 0 hellotime 0 fwddelay 0</span><br><span class="line">		maxage 0 holdcnt 0 proto stp maxaddr 100 timeout 1200</span><br><span class="line">		root id 0:0:0:0:0:0 priority 0 ifcost 0 port 0</span><br><span class="line">		ipfilter disabled flags 0x2</span><br><span class="line">	member: en1 flags=3&lt;LEARNING,DISCOVER&gt;</span><br><span class="line">	        ifmaxaddr 0 port 9 priority 0 path cost 0</span><br><span class="line">	member: en2 flags=3&lt;LEARNING,DISCOVER&gt;</span><br><span class="line">	        ifmaxaddr 0 port 10 priority 0 path cost 0</span><br><span class="line">	nd6 options=201&lt;PERFORMNUD,DAD&gt;</span><br><span class="line">	media: &lt;unknown type&gt;</span><br><span class="line">	status: inactive</span><br><span class="line">utun0: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 2000</span><br><span class="line">	inet6 fe80::3fe0:3e8b:384:9968%utun0 prefixlen 64 scopeid 0xc</span><br><span class="line">	nd6 options=201&lt;PERFORMNUD,DAD&gt;</span><br><span class="line">utun1: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1380</span><br><span class="line">	inet6 fe80::7894:3abc:5abd:457d%utun1 prefixlen 64 scopeid 0xd</span><br><span class="line">	nd6 options=201&lt;PERFORMNUD,DAD&gt;</span><br></pre></td></tr></table></figure>
<p>内容很多，我挑几点差异简述下：</p>
<ul>
<li><p>内容展示形式不一样，没有 Linux 下的接收、发送数据字节数等统计信息</p>
</li>
<li><p>真实网卡的命名不一样：eth0 -&gt; en0</p>
</li>
<li>虚拟网卡的命名格式不一样：tun/tap -&gt; utun</li>
</ul>
<p>对于这些常见网卡命名的解读，我摘抄一部分来自 stackoverflow 的回答：</p>
<blockquote>
<p>In arbitrary order of my familarity / widespread relevance:</p>
<p><code>lo0</code> is loopback.</p>
<p><code>en0</code> at one point “ethernet”, now is WiFi (and I have no idea what extra <code>en1</code> or <code>en2</code> are used for).</p>
<p><code>fw0</code> is the FireWire network interface.</p>
<p><code>stf0</code> is an <a href="https://www.freebsd.org/cgi/man.cgi?gif(4" target="_blank" rel="noopener">IPv6 to IPv4 tunnel interface</a>) to support <a href="http://en.wikipedia.org/wiki/6to4" target="_blank" rel="noopener">the transition</a> from IPv4 to the IPv6 standard.</p>
<p><code>gif0</code> is a more <a href="https://www.freebsd.org/cgi/man.cgi?gif(4" target="_blank" rel="noopener">generic tunneling interface</a>) [46]-to-[46].</p>
<p><code>awdl0</code> is <a href="https://stackoverflow.com/questions/19587701/what-is-awdl-apple-wireless-direct-link-and-how-does-it-work" target="_blank" rel="noopener">Apple Wireless Direct Link</a></p>
<p><code>p2p0</code> is related to AWDL features. Either as an old version, or virtual interface with different semantics than <code>awdl</code>.</p>
<p>the “Network” panel in System Preferences to see what network devices “exist” or “can exist” with current configuration.</p>
<p>many VPNs will add additional devices, often “utun#” or “utap#” following <a href="https://en.wikipedia.org/wiki/TUN/TAP" target="_blank" rel="noopener">TUN/TAP (L3/L2)</a>virtual networking devices.</p>
<p>use <code>netstat -nr</code> to see how traffic is currently routed via network devices according to destination.</p>
<p>interface naming conventions started in BSD were retained in OS X / macOS, and now there also additions.</p>
</blockquote>
<h2 id="8-Dubbo-改进建议"><a href="#8-Dubbo-改进建议" class="headerlink" title="8 Dubbo 改进建议"></a>8 Dubbo 改进建议</h2><p>我们进行了以上探索，算是对网卡有一点了解了。回过头来看看 Dubbo 获取网卡的逻辑，是否可以做出改进呢？</p>
<p><strong>Dubbo Action 1:</strong> </p>
<p>保持 Ipv4 和 Ipv6 的一致性校验。为 Ipv4 增加连通性校验；为 Ipv6 增加 LoopBack 和 ANYHOST 等校验。</p>
<p><strong>Dubbo Action 2:</strong> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">NetworkInterface network = interfaces.nextElement();</span><br><span class="line"><span class="keyword">if</span> (network.isLoopback() || network.isVirtual() || !network.isUp()) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JDK 提供了以上的 API，我们可以利用起来，过滤一部分一定不正确的网卡。</p>
<p><strong>Dubbo Action 3:</strong> </p>
<p>我们本文花了较多的篇幅介绍了 docker 和 TUN/TAP 两种场景导致的虚拟网卡的问题，算是较为常见的一个影响因素，虽然他们的命名具有固定性，如 docker0、tunX、tapX，但我觉得通过网卡名称的判断方式去过滤注册 IP 有一些 hack，所以不建议 dubbo contributor 提出相应的 pr 去增加这些 hack 判断，尽管可能会对判断有所帮助。</p>
<p>对于真实多网卡、内外网 IP 共存的场景，不能仅仅是框架层在做努力，用户也需要做一些事，就像爱情一样，我可以主动一点，但你也得反馈，才能发展出故事。</p>
<p><strong>Dubbo User Action 1:</strong></p>
<p>可以配置 <code>/etc/hosts</code> 文件，将 hostname 对应的 IP 显式配置进去。</p>
<p><strong>Dubbo User Action 2:</strong></p>
<p>可以使用启动参数去显式指定注册的 IP：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">-DDUBBO_IP_TO_REGISTRY=<span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
<p>也可以指定 Dubbo 服务绑定在哪块网卡上：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">-DDUBBO_IP_TO_BIND=<span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
<h2 id="9-参考文章"><a href="#9-参考文章" class="headerlink" title="9 参考文章"></a>9 参考文章</h2><p><a href="https://www.jianshu.com/p/09f9375b7fa7" target="_blank" rel="noopener">TUN/TAP 设备浅析</a></p>
<p><a href="https://stackoverflow.com/questions/29958143/what-are-en0-en1-p2p-and-so-on-that-are-displayed-after-executing-ifconfig" target="_blank" rel="noopener">what-are-en0-en1-p2p-and-so-on-that-are-displayed-after-executing-ifconfig</a></p>
<p><a href="http://dubbo.apache.org/zh-cn/blog/dubbo-network-interfaces.html" target="_blank" rel="noopener">原文地址</a> | <a href="https://github.com/apache/dubbo-website/edit/asf-site/blog/zh-cn/dubbo-network-interfaces.md" target="_blank" rel="noopener">纠错</a></p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2024-04-23T01:48:15.039Z" itemprop="dateUpdated">2024-04-23 09:48:15</time>
</span><br>


        
        原始链接：<a href="/20191016/dubbo-network-interfaces.md.html" target="_blank" rel="external">https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html</a><br>版权声明：本文由 <strong>凝雨-Yun</strong> 原创，采用<strong><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a></strong>进行许可。 <br><strong>转载请注明作者及出处！</strong><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a>
        
    </div>
    
    <footer>
        <a href="https://ningyu1.github.io">
            <img src="/img/avatar.jpg" alt="凝雨">
            凝雨
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/网卡地址注册/">网卡地址注册</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html&title=《[转]研究 Dubbo 网卡地址注册时的一点思考》 — 凝雨 - Yun&pic=https://ningyu1.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html&title=《[转]研究 Dubbo 网卡地址注册时的一点思考》 — 凝雨 - Yun&source=快乐编程每一天 - Happy Coding Every Day" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《[转]研究 Dubbo 网卡地址注册时的一点思考》 — 凝雨 - Yun&url=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html&via=https://ningyu1.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/20200325/one-minute-transaction-ACID.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">一分钟弄清楚事务四要素：ACID</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/20191015/118-cas-server-pit.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Trouble Shooting —— CAS Server集群环境下TGC验证问题</h4>
      </a>
    </div>
  
</nav>



    

















<section class="comments" id="comments">
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
        var id = location.pathname
        if (location.pathname.length > 50) {
          id = location.pathname.replace(/\/\d+\/\d+\/\d+\//, '').replace('/', '').substring(0, 50)
        }
        const gitalk = new Gitalk({
          clientID: '298f0d78bd14c9c0ff01',
          clientSecret: 'e81e4d36caf1a13d2f05ed5dcf30e636dde749ac',
          repo: 'blog',
          owner: 'ningyu1',
          admin: ['ningyu1'],
          id: id,      // Ensure uniqueness and length less than 50
	  //id: 'Comments',
          title: document.title.split('|')[0],
          distractionFreeMode: false  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>
</section>




</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        可以吃个鸡腿吗？
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.zh">知识共享署名-相同方式共享 4.0 国际许可协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>凝雨 &copy; 2016 - 2024</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html&title=《[转]研究 Dubbo 网卡地址注册时的一点思考》 — 凝雨 - Yun&pic=https://ningyu1.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html&title=《[转]研究 Dubbo 网卡地址注册时的一点思考》 — 凝雨 - Yun&source=快乐编程每一天 - Happy Coding Every Day" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《[转]研究 Dubbo 网卡地址注册时的一点思考》 — 凝雨 - Yun&url=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html&via=https://ningyu1.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://ningyu1.github.io/20191016/dubbo-network-interfaces.md.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACtklEQVR42u3aQY5jIQwFwNz/0pntjFqfvGdAnZGKVZR0+C5awsTm9YrH+6+x/vTnX65fJzP/fH144OHh4W2Evg4xeViObENfL83jMuHh4eFd47WbcpsqZrt3myTw8PDwvpOXh7KGzfB4eHh4/yOvfWf9fn5QxsPDw/s23s50SaB5skmW70qtBQ8PDy/m5V2k73l9pb+Hh4eHt91Vn224742RHM2L2fDw8PAu8Nq2/azZP9vc1wfuojSMh4eHd5Q3+3mfFCbahLFzgeBxEfHw8PCu8ZKj8yysvFB74xoBHh4e3g3ebMNNQplt9zup4kNUeHh4eEd56y/MYHlimHXtim/h4eHhHeXNgkiOs3na2LlWVRQj8PDw8I7ykqDzUkJezthPDx+WDA8PD+8Cb1ZgnTXAZk2ytvH2+D/Ew8PDO8TLC6ZJ2piVcfOmV5LSXvtB4OHh4Y14O+/stPlPPf3DnTI8PDy8Q7x2O27LBG2qaNtydZcMDw8P73x3PrpYMAs0mW3nyI6Hh4d3j9eWCWah58s0W/THqPDw8PAu8NqDb96m2k8YZwvNeHh4eKd4SShtSsibVcXaj47+eHh4ePd460lbRl60nZUekjIxHh4e3m1eXobID8HtFau86VUkEjw8PLwLvHZb3zlk50WE9nAfFYXx8PDwjvJ2rj2116ry77bljCgl4OHh4V3gtQ2nNm0kSzlLUY9sPDw8vGu8nc16n/E6ND7UqvHw8PC2ee9ytKWHYo0PpaJ/PsXDw8O7wGs33Hbq9kCczHDqkhYeHh7eDi9PBvsbdIs88Fw8PDy8a7z1wTcvs+YNtvxqQltfwcPDw/t+3gyWPDGJra5S4+Hh4f0Sry3d5oz3aDQtPzw8PLwzvLYQsHNNaqdYXC8xHh4e3gXebCtvU0gS0Ky8e/iuFh4eHt5q/AHct5KX/h3vzQAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-indigo-patch@1.0.0/source/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>










</body>
</html>
